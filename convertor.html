<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toki Pona Converter</title>
  <style>
    :root {
      --bg: #fafafa;
      --fg: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --chip: #f3f4f6;
    }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 16px; box-sizing: border-box;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--fg);
    }
    .wrap { max-width: 920px; margin: 0 auto; }
    h1 { font-size: 18px; margin: 0 0 8px; font-weight: 600; }
    .muted { color: var(--muted); font-size: 12px; }
    textarea {
      width: 100%; min-height: 180px; resize: vertical; padding: 12px 14px;
      border: 1px solid var(--border); border-radius: 8px; outline: none;
      background: #fff; color: inherit; line-height: 1.5;
    }
    .result {
      margin-top: 12px; padding: 14px; min-height: 140px;
      border: 1px solid var(--border); border-radius: 8px; background: #fff;
      line-height: 1.7;
    }
    /* Tooltip styling for converted tokens */
    .result span { cursor: help; border-bottom: 1px dotted #9ca3af; }
    .result .mark { color: #9ca3af; }
    .status { margin: 8px 0 6px; }
    .chip { display:inline-block; padding:2px 8px; background:var(--chip); border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Toki Pona Converter</h1>

    <div class="row" role="group" aria-label="Dictionary controls">
      <div class="select">
        <span class="muted">Preset:</span>
        <select id="dictSelect" aria-label="Choose preset dictionary"></select>
      </div>
      <div class="file">
        <label for="dictUpload" class="muted">Upload CSV:</label>
        <input id="dictUpload" type="file" accept=".csv,text/csv" />
      </div>
      <span id="activeDict" class="chip" title="Current dictionary name">No dictionary yet</span>
    </div>

    <div class="muted status" id="status"><span class="chip">Loading dictionary…</span></div>

    <textarea id="input" placeholder="Type Toki Pona here… e.g. jan li moku e kili."></textarea>
    <div id="result" class="result" aria-live="polite"></div>
  </div>

  <script>
    // --- Configuration & helpers ------------------------------------------------
    const PUNC_MAP = {
      ',': '，', '.': '。', '!': '！', '?': '？', ':': '：', ';': '；',
      '(': '（', ')': '）', '[': '【', ']': '】', '<': '《', '>': '》'
    };

    const PRESETS = [
      { id: 'default', label: 'Default (dictionary.csv)', path: 'dictionary.csv' },
      { id: 'conservative', label: 'Conservative (dictionary_c.csv)', path: 'dictionary_c.csv' },
    ]

    const LS_KEYS = {
      presetId: 'tp_dict_preset_id',
      customCSV: 'tp_dict_custom_csv', // 保存用户上传的 CSV 文本，便于刷新后继续使用
      lastName:  'tp_dict_last_name'
    };

    // Highlight function words (same as the Python version)
    const MARK = new Set(['li', 'e', 'pi', 'o', 'la']);

    let MAPPING = Object.create(null);     // { toki_pona_word -> target_string }
    let TOOLTIP = Object.create(null);     // { toki_pona_word -> brief_cn_translation }

    function escapeHTML(s) {
      return s
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function isLowerAsciiWord(s) {
      return /^[a-z]+$/.test(s);
    }

    // Minimal CSV splitter that supports quoted fields
    function splitCSVLine(line) {
      const out = []; let cur = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i + 1] === '"') { cur += '"'; i++; } // escaped quote
            else { inQuotes = false; }
          } else {
            cur += ch;
          }
        } else {
          if (ch === ',') { out.push(cur); cur = ''; }
          else if (ch === '"') { inQuotes = true; }
          else { cur += ch; }
        }
      }
      out.push(cur);
      return out;
    }

    function parseDictionaryCSV(csvText) {
      csvText = csvText.replace(/^\uFEFF/, ''); // strip BOM
      const lines = csvText.split(/\r?\n/);
      const mapping = Object.create(null);
      const tooltip = Object.create(null);

      for (let i = 0; i < lines.length; i++) {
        const raw = lines[i];
        if (!raw || !raw.trim()) continue;
        if (i === 0) continue; // skip header
        const cols = splitCSVLine(raw);
        if (cols.length >= 2 && cols[0].trim()) {
          const key = cols[0].trim();
          const val = (cols[1] || '').trim();
          const cn  = (cols[2] || '').trim();
          mapping[key] = val;
          tooltip[key] = cn;
        }
      }
      return { mapping, tooltip };
    }

    // --- Core conversion --------------------------------------------------------
    function convert(text) {
      const tokens = text.split(/(\W+)/); // keep delimiters
      const htmlParts = [];

      for (const token of tokens) {
        if (isLowerAsciiWord(token) && Object.prototype.hasOwnProperty.call(MAPPING, token)) {
          const out = MAPPING[token];
          const tip = `${token} : ${TOOLTIP[token] || ''}`;
          const markClass = MARK.has(token) ? ' class="mark"' : '';
          htmlParts.push(`<span${markClass} title="${escapeHTML(tip)}">${escapeHTML(out)}</span>`);
        } else {
          // Apply punctuation map char-by-char
          let converted = Array.from(token).map(ch => PUNC_MAP[ch] ?? ch).join('');
          converted = escapeHTML(converted).replaceAll('\n', '\n<br>');
          htmlParts.push(converted);
        }
      }
      document.getElementById('result').innerHTML = htmlParts.join('');
    }

    function setStatus(msg, ok=true) {
      const status = document.getElementById('status');
      status.innerHTML = `<span class="chip" style="${ok ? '' : 'color:#b91c1c'}">${escapeHTML(msg)}</span>`;
    }
    function setActiveDictName(name) {
      document.getElementById('activeDict').textContent = name;
      localStorage.setItem(LS_KEYS.lastName, name);
    }

    // --- Dictionary loading -----------------------------------------------------
    async function loadCSVText(csvText, displayName) {
      const parsed = parseDictionaryCSV(csvText);
      MAPPING = parsed.mapping;
      TOOLTIP = parsed.tooltip;
      setStatus(`Dictionary loaded ✓ (${Object.keys(MAPPING).length} entries)`, true);
      setActiveDictName(displayName);
      // 触发一次渲染
      convert(document.getElementById('input').value || '');
    }

    async function loadDictionaryFromURL(url, displayName) {
      try {
        setStatus(`Loading ${displayName}…`);
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const csv = await res.text();
        await loadCSVText(csv, displayName);
        // 清理自定义缓存（此时以预设为准）
        localStorage.removeItem(LS_KEYS.customCSV);
      } catch (e) {
        console.error(e);
        setStatus(`Failed to load ${displayName}. Place it beside this HTML file.`, false);
      }
    }

    async function loadDictionaryFromFile(file) {
      const text = await file.text();
      await loadCSVText(text, `Custom: ${file.name}`);
      // 缓存自定义 CSV 文本，刷新后也能恢复
      try { localStorage.setItem(LS_KEYS.customCSV, text); } catch {}
    }

    // --- UI wiring --------------------------------------------------------------
    function populatePresetSelect(selectEl) {
      selectEl.innerHTML = '';
      for (const p of PRESETS) {
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.label;
        selectEl.appendChild(opt);
      }
      // 如果有“已保存的自定义”也加一个虚拟项
      if (localStorage.getItem(LS_KEYS.customCSV)) {
        const opt = document.createElement('option');
        opt.value = '__custom_saved__';
        opt.textContent = 'Custom (saved from upload)';
        selectEl.appendChild(opt);
      }
    }

    async function init() {
      const select = document.getElementById('dictSelect');
      const upload = document.getElementById('dictUpload');
      const inputEl = document.getElementById('input');

      populatePresetSelect(select);

      // 绑定事件：选择预设
      select.addEventListener('change', async (e) => {
        const val = e.target.value;
        if (val === '__custom_saved__') {
          const csv = localStorage.getItem(LS_KEYS.customCSV);
          if (csv) await loadCSVText(csv, 'Custom (saved)');
          else setStatus('No saved custom dictionary.', false);
          localStorage.setItem(LS_KEYS.presetId, val);
          return;
        }
        const preset = PRESETS.find(p => p.id === val) || PRESETS[0];
        localStorage.setItem(LS_KEYS.presetId, preset.id);
        await loadDictionaryFromURL(preset.path, preset.label);
      });

      // 绑定事件：上传文件
      upload.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        await loadDictionaryFromFile(file);
        // 确保下拉里出现“Custom (saved)”选项并选中
        populatePresetSelect(select);
        select.value = '__custom_saved__';
        localStorage.setItem(LS_KEYS.presetId, '__custom_saved__');
      });

      // 输入联动
      inputEl.addEventListener('input', (e) => convert(e.target.value));
      convert(inputEl.value || '');

      // 恢复上次选择
      const lastPresetId = localStorage.getItem(LS_KEYS.presetId);
      if (lastPresetId === '__custom_saved__' && localStorage.getItem(LS_KEYS.customCSV)) {
        select.value = '__custom_saved__';
        await loadCSVText(localStorage.getItem(LS_KEYS.customCSV), 'Custom (saved)');
      } else {
        const preset = PRESETS.find(p => p.id === lastPresetId) || PRESETS[0];
        select.value = preset.id;
        await loadDictionaryFromURL(preset.path, preset.label);
      }

      // 显示上一次名字（可选）
      const lastName = localStorage.getItem(LS_KEYS.lastName);
      if (lastName) setActiveDictName(lastName);
    }

    init();
  </script>
</body>
</html>
